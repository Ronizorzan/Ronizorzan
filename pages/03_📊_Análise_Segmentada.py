#Importa√ß√£o das bibliotecas
import streamlit as st
import pandas as pd
from funcoes import *
from utilidades import *

#Configura√ß√£o da p√°gina
st.set_page_config(page_title="An√°lise de Clientes por Segmento", layout="wide", initial_sidebar_state="expanded")


with st.sidebar:
    data = pd.read_csv("dados_segment.csv")
    segmentacao = st.selectbox("Selecione o Segmento para An√°lise:", ['Profiss√£o', 'Renda', 'Estado Civil',
                                                'Valor Solicitado', 'Solicitado vs Total Bem', 'Renda vs ValorSolicitado'])
    processar = st.button("Gerar An√°lise", type="primary", use_container_width=True)
    st.sidebar.markdown("""
### üí° O Que Esta An√°lise Revela?

Esta se√ß√£o funciona como um :orange[**raio-X do nosso risco de cr√©dito**], permitindo-nos entender o porque de alguns clientes se tornarem inadimplentes e outros n√£o.

A an√°lise segmentada revela :orange[**padr√µes ocultos por tr√°s da inadimpl√™ncia**] e nos mostra, com clareza, quais perfis e cen√°rios financeiros representam os maiores riscos e, consequentemente, as melhores oportunidades de melhoria.

Com essa intelig√™ncia, sa√≠mos da rea√ß√£o para a **a√ß√£o estrat√©gica**: podemos ajustar pol√≠ticas de cr√©dito, direcionar o marketing e otimizar nosso portf√≥lio de produtos de forma muito mais eficaz.

‚ö†Ô∏è **Ponto de Aten√ß√£o:**
√â importante ressaltar que, embora um fator isolado (como `Renda`) mostre forte correla√ß√£o com o risco, 
                        a inadimpl√™ncia √© complexa e pode estar associada a outras vari√°veis, pois um cliente n√£o √© apenas sua profiss√£o, mas a soma de todas as suas caracter√≠sticas.
                        A causa real do risco geralmente est√° na **combina√ß√£o de m√∫ltiplos fatores** (ex: uma certa profiss√£o *com* uma determinada faixa de renda e *um certo* valor solicitado).
""")
if processar:
    if segmentacao=='Profiss√£o':
        st.header("Profiss√£o do Cliente √© um Indicador Surpreendentemente Forte de Risco de Cr√©dito", divider="orange")
        ax, resumo, grafico = plot_rate_by_group(
        df=data,
        target="classe",
        group=segmentacao,
        bin_strategy="quantile",
        min_count=15,
        sort_by="rate",
        ascending=False,
        title="Inadimpl√™ncia por Profiss√£o",
        show_ci=False,
        figsize=(9,6)
    )
        col1, col2 = st.columns([0.49,0.51])        
        with col1:
            st.pyplot(grafico, use_container_width=True)
        
        with col2:
            st.markdown("""**Observa√ß√£o-Chave:** Profiss√µes como Arquiteto e Dentista apresentam taxas de inadimpl√™ncia superiores a :red[**50%**],
                         enquanto Engenheiros se destacam como o grupo com as menores taxas em nossa carteira: :green[**(16,7%)**].

**O Valor da An√°lise:** Essa vis√£o nos permite ir al√©m dos dados financeiros e entender o contexto do cliente. Ela abre portas para estrat√©gias de marketing e parcerias direcionadas,
                         permitindo-nos "direcionar" ativamente para um perfil de cliente mais atrativo para o neg√≥cio.

**A√ß√µes Recomendadas:**
Essa an√°lise permite criar uma "Intelig√™ncia de Mercado", Mapeando o Risco por Profiss√£o para Atrair os Melhores Clientes."

- **Marketing e Parcerias Estrat√©gicas:** Por que n√£o criar campanhas e parcerias direcionadas a conselhos de engenharia ou empresas de tecnologia, oferecendo condi√ß√µes especiais?
                         Esta √© uma forma proativa de aumentar a propor√ß√£o de bons clientes em nossa base.

- **Motor de Risco:** A "profiss√£o" deve ser uma vari√°vel com peso consider√°vel em nosso modelo de "Risco de Cr√©dito". A an√°lise mostra que ela tem um poder preditivo consideravelmente relevante.

- **An√°lise de Cr√©dito:** Para determinadas profiss√µes, pode-se solicitar documenta√ß√£o adicional que comprove a estabilidade de renda para tomar uma decis√£o mais bem informada.""")


    if segmentacao=='Renda':
        st.header("Renda S√≥ Faz a Diferen√ßa no Topo da Pir√¢mide", divider="orange")
        ax, resumo, grafico = plot_rate_by_group(
        df=data,
        target="classe",
        group=segmentacao,
        bins=4,
        bin_strategy="quantile",
        min_count=15,
        sort_by="rate",
        ascending=False,
        title="Inadimpl√™ncia por faixa de Renda",
        show_ci=False,
        figsize=(8,6)
    )
        col1, col2 = st.columns([0.51,0.49])
        with col1:            
            st.pyplot(grafico, use_container_width=True)
        
        with col2:
            st.markdown("""**Observa√ß√£o-Chave:** A inadimpl√™ncia permanece uniformemente alta :red[**(cerca de 44%)**] para todas as faixas de renda (***abaixo de 46 mil***.)
                         Apenas o grupo com a maior renda (***acima de 46 mil***) mostra uma queda significativa na inadimpl√™ncia :green[**(28,9%)**].

**O Valor da An√°lise:** Esta an√°lise quebra o mito de que "renda maior √© sempre igual a risco menor". Ela revela a exist√™ncia de um "ponto de virada".
                         Aumentar a renda de 10 para 30 mil n√£o alterou o comportamento de pagamento em nossa base. O diferencial est√° em pertencer ao topo da pir√¢mide.

**A√ß√µes Recomendadas:**
- Onde devemos concentrar os esfor√ßos? Nosso cliente "ideal" em termos de renda est√° claramente no topo da pir√¢mide. Esfor√ßos de aquisi√ß√£o e produtos premium 
                        podem ser direcionados para este p√∫blico, que oferece o melhor equil√≠brio entre volume e seguran√ßa.

- **Combina√ß√£o de Vari√°veis:** Esta an√°lise √© mais poderosa quando combinada com a de "Comprometimento Financeiro". Um cliente de alta renda (> R$ 46 mil) que solicita um valor baixo (Alta Renda vs ValorSolicitado baixo) √© uma aposta de ouro.
                        Um cliente de renda m√©dia ou baixa solicitando um valor que compromete sua renda √© uma aposta perigosa.

- **Questionamento do Neg√≥cio:** Por que os clientes de renda m√©dia e baixa se comportam de maneira t√£o similar? O valor do nosso produto est√° mal ajustado para a realidade financeira desses segmentos?
                        Esta √© uma pergunta estrat√©gica que pode levar √† cria√ß√£o de novos produtos ou a ajustes nos existentes.""")


    if segmentacao=='Estado Civil':
        st.header("Estado Civil Revela Padr√µes de Risco Surpreendentes", divider="orange")
        ax, resumo, grafico = plot_rate_by_group(
        df=data,
        target="classe",
        group=segmentacao,
        bins=4,
        bin_strategy="quantile",
        min_count=15,
        sort_by="rate",
        ascending=False,
        title="Inadimpl√™ncia por Score de Cr√©dito",
        show_ci=False
    )
        col1, col2 = st.columns([0.6,0.4])
        with col1:
            st.pyplot(grafico, use_container_width=True)
        
        with col2:
            st.markdown(""" **Observa√ß√£o-Chave:** Clientes casados comp√µem nosso segmento de maior risco :red[**(58.0%)**], com uma taxa de inadimpl√™ncia que se aproxima do dobro 
                        da de clientes solteiros :green[**(29.2%)**], nosso grupo mais seguro atualmente.

**O Valor da An√°lise:** Este insight desafia o senso comum de que "casado" equivale a maior estabilidade financeira. Para nossa carteira de clientes, essa condi√ß√£o sinaliza maior press√£o financeira e risco.
                        Essa vari√°vel √© uma pe√ßa-chave para refinar nosso entendimento sobre o perfil do cliente.

**A√ß√µes Recomendadas:**
- **Motor de Risco:** O "Estado Civil" deve ser incorporado como uma vari√°vel de peso em nossos modelos preditivos de inadimpl√™ncia.
- **An√°lise Aprofundada:** Devemos cruzar o estado civil com outras vari√°veis (como faixa de renda, profiss√£o e valor solicitado) para descobrir a causa raiz. Clientes casados solicitam valores maiores? Possuem mais dependentes?
- **Estrat√©gia de Marketing:** Campanhas com comunica√ß√£o e ofertas direcionadas ao p√∫blico solteiro podem ser uma maneira eficaz de atrair uma base de clientes com menor risco inerente.
""")

    if segmentacao=='Valor Solicitado':
        st.header("Empr√©timos Menores podem significar Risco Menor.")
        ax, resumo, grafico = plot_rate_by_group(
        df=data,
        target="classe",
        group=segmentacao,
        bins=4,
        bin_strategy="quantile",
        min_count=15,
        sort_by="rate",
        ascending=False,
        title="Inadimpl√™ncia por Cr√©dito Solicitado",
        show_ci=False
    )
        col1, col2 = st.columns([0.6,0.4])
        with col1:
            st.pyplot(grafico, use_container_width=True)
        
        with col2:
            st.markdown(""" **Observa√ß√£o-Chave:** Pedidos de cr√©dito de alto valor (acima de 123.000) resultam em uma taxa de inadimpl√™ncia alarmante de :red[**75%**].
                        Em contrapartida, os pedidos de menor valor (at√© 70.000) s√£o os mais seguros de toda a carteira, com :green[**0% de inadimpl√™ncia**].

**O Valor da An√°lise:** Esta an√°lise sugere que ***"emprestar pouco √© mais seguro"***, algo bastante intuitivo. Ela indica que o *perfil* do cliente que busca valores menores √© menos arriscado,
                         enquanto clientes que solicitam valores maiores tendem a ser mais "arriscados".

**A√ß√µes Recomendadas:**
- **Estrat√©gia de Produto:** A rentabilidade do nosso produto de m√©dio valor precisa ser reavaliada. A precifica√ß√£o atual (taxas) √© suficiente para cobrir um "risco" de 75%? 
                        Talvez seja necess√°rio um score de aprova√ß√£o mais rigoroso para esta faixa.
- **Oportunidade de Crescimento:** O segmento de baixo valor √© uma ***"mina de ouro"***. Podemos criar produtos premium ou programas de fidelidade para atrair e reter mais clientes que solicitam valores at√© de R$ 70.000.
- **An√°lise de Cr√©dito:** A an√°lise de risco para pedidos de **m√©dio √† alto valor** deve ser *mais* criteriosa, para proteger a sa√∫de financeira da empresa.
""")
    

    if segmentacao=='Solicitado vs Total Bem':
        st.header("Quanto menor a entrada, maior o risco de Inadimpl√™ncia Futura.", divider="orange")
        ax, resumo, grafico = plot_rate_by_group(
        df=data,
        target="classe",
        group=segmentacao,
        bin_strategy="quantile",
        bins=4,
        min_count=20,
        sort_by="rate",
        ascending=False,
        title="Inadimpl√™ncia por propor√ß√£o financiada",
        show_ci=False
    )
        col1, col2 = st.columns([0.6,0.4])
        with col1:
            st.pyplot(grafico, use_container_width=True)
        
        with col2:
            st.markdown(""" **Observa√ß√£o-Chave:** A propor√ß√£o do bem que o cliente financia √© um indicador fort√≠ssimo de inadimpl√™ncia.
                        Clientes que deram uma entrada robusta (financiando at√© 33% do item) apresentaram uma baixa taxa de inadimpl√™ncia :green[**menos de 15.0%**]. 
                        Em contraste, aqueles que financiaram uma alta propor√ß√£o (acima de 33%) se tornaram inadimplentes em :red[**83.8%**] dos casos.

**O Valor da An√°lise:** Esta an√°lise nos entrega uma regra de neg√≥cio clara, poderosa e intuitiva. O valor da entrada (ou "sinal") √© um reflexo direto do comprometimento e da capacidade do cliente de honrar os compromissos.
                        √â uma informa√ß√£o que podemos usar para automatizar e blindar nosso processo de cr√©dito.

**A√ß√µes Recomendadas:**
- **Pol√≠tica de Cr√©dito Automatizada:** Implementar regras de corte r√≠gidas na an√°lise de cr√©dito. Financiamentos com propor√ß√£o acima de 30% devem ser negados ou escalados para an√°lise gerencial.
                        Propostas com financiamento abaixo de 20% podem ser pr√©-aprovadas.
- **Estrat√©gia de Vendas e Produto:** Podemos incentivar entradas maiores? Oferecer taxas de juros reduzidas para clientes que pagam um sinal maior √© uma estrat√©gia "ganha-ganha":
                         melhora a qualidade da nossa carteira e torna a oferta mais atrativa para bons clientes.
""")
        

    if segmentacao=='Renda vs ValorSolicitado':
        st.header("Quanto Menor a Renda em Rela√ß√£o ao Empr√©stimo, Maior a Certeza do Preju√≠zo.", divider="orange")
        ax, resumo, grafico = plot_rate_by_group(
        df=data,
        target="classe",
        group=segmentacao,
        bin_strategy="quantile",
        bins=4,
        min_count=20,
        sort_by="rate",
        ascending=False,
        title="Inadimpl√™ncia por Comprometimento Financeiro",
        show_ci=False,
        figsize=(8,6)
    )
        col1, col2 = st.columns([0.51,0.49], gap="large")
        with col1:
            st.pyplot(grafico, use_container_width=True)
        
        with col2:
            st.markdown("""**Observa√ß√£o-Chave:** O risco de inadimpl√™ncia est√° diretamente ligado ao quanto o cliente compromete de sua renda.
                        Clientes cuja renda anual corresponde a at√© 30% do valor solicitado apresentaram uma taxa de inadimpl√™ncia alt√≠ssima ***(aproximadamente 60%)***, 
                        enquanto aqueles cuja renda anual corresponde √† mais da metade do valor solicitado nunca se tornaram inadimplentes.

**O Valor da An√°lise:** Esta √© a m√©trica mais poderosa para a tomada de decis√£o. Ela nos d√° uma regra clara e quantific√°vel para separar propostas de alto e baixo risco
    antes mesmo de uma an√°lise aprofundada.√â o nosso sistema de alerta precoce mais eficaz.

**A√ß√µes Recomendadas:**                        
**Pol√≠tica de Cr√©dito:** Devemos usar essa vari√°vel para criar faixas de aprova√ß√£o autom√°ticas?

- **Faixa Segura** :green[**(> 51.54):**] Clientes nesta faixa podem ser pr√©-aprovados ou passar por um processo "Aprova√ß√£o-r√°pida", melhorando a experi√™ncia do usu√°rio e nossa agilidade competitiva.

- **Faixa de Alerta** :red[**(< 29.54):**] Propostas nesta faixa devem ser automaticamente recusadas ou enviadas para uma an√°lise manual mais rigorosa. Isso representa a nossa maior oportunidade de redu√ß√£o de perdas.

- **Oportunidade de Produto:** Podemos criar um produto de "cr√©dito expresso" com aprova√ß√£o instant√¢nea para o perfil de cliente mais seguro, atraindo e fidelizando os melhores pagadores do mercado.
                                        """)



